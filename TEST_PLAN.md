# 自動テスト計画書（初心者向け完全ガイド）

## 📋 この文書について

この文書は、VSCode + Docker開発環境リポジトリの3つのサンプルプロジェクトに対する**自動テスト**（コンピュータが自動的にプログラムの動作を確認する仕組み）の計画書です。

### 💡 専門用語解説

- **テスト**: プログラムが正しく動くか確認する作業
- **自動テスト**: 人間が手で確認せず、コンピュータが自動的にテストを実行すること
- **テストケース**: 「この操作をしたら、こうなるはず」という確認項目
- **カバレッジ**: テスト対象のコードのうち、実際にテストされた割合（%で表示）

---

## 🎯 対象プロジェクト

このリポジトリには3つのサンプルアプリケーションがあり、それぞれにテストを作成しました：

### 1. nodejs-postgres
- **使用技術**: Node.js（JavaScript実行環境）+ Express（Webサーバー）+ React（画面表示）
- **データベース**: PostgreSQL + Redis
- **テスト数**: 56ケース

### 2. python-fastapi
- **使用技術**: FastAPI（Python製の高速Webフレームワーク）+ React
- **データベース**: PostgreSQL + Redis
- **テスト数**: 58ケース

### 3. python-flask
- **使用技術**: Flask（Python製のシンプルなWebフレームワーク）+ React
- **データベース**: PostgreSQL
- **テスト数**: 62ケース

**合計テストケース数: 176個** 🎉

---

## 🎯 テストの種類と目的

プログラムをテストする方法はいくつかあります。それぞれの役割を理解しましょう：

### 1. ユニットテスト（部品単体のテスト）

**何をテストする？**: 1つ1つの関数やメソッドが正しく動くか

**例**:
- パスワードを暗号化する関数が正しく動くか
- 数値を計算する関数が正しい答えを返すか

**目標カバレッジ**: 80%以上
（コードの8割以上をテストで確認する）

### 2. 統合テスト（組み合わせのテスト）

**何をテストする？**: 複数の部品を組み合わせた時に正しく動くか

**例**:
- ユーザー登録APIを呼び出したら、データベースに保存されるか
- ログインAPIでトークン（ログイン証明書）が正しく発行されるか

**目標**: 全てのAPIエンドポイント（URLの入口）をテスト

**💡 APIエンドポイント**: プログラム同士が通信するための入口のこと
例: `POST /auth/register`（ユーザー登録の入口）

### 3. E2Eテスト（End to End = 最初から最後まで）

**何をテストする？**: 実際のユーザーの操作を再現して、全体が動くか

**例**:
- ブラウザを開く → ログインボタンを押す → IDとパスワードを入力 → ダッシュボードが表示される

**目標**: 重要な操作の流れ（クリティカルパス）を全てテスト

### 4. コンポーネントテスト（画面部品のテスト）

**何をテストする？**: 画面に表示されるボタンやフォームが正しく動くか

**例**:
- ログインフォームにユーザー名を入力できるか
- ボタンを押したら、正しい関数が呼ばれるか

---

## 📚 テストで確認する内容（共通）

全てのプロジェクトで以下の内容をテストします：

### ✅ 認証フロー（ログイン機能）

**テスト項目**:
1. **ユーザー登録**
   - ✅ 正しい情報で登録できる
   - ❌ 同じユーザー名で2回登録できない
   - ❌ 短すぎるパスワードは拒否される

2. **ログイン**
   - ✅ 正しいIDとパスワードでログインできる
   - ❌ 間違ったパスワードではログインできない

3. **トークン検証**（ログイン証明書の確認）
   - ✅ 有効なトークンで保護されたページにアクセスできる
   - ❌ 無効なトークンではアクセスできない

**💡 JWT（JSON Web Token）**: ログインした証明として発行される暗号化された文字列。
例: `eyJhbGci...` のような長い文字列

### ✅ データベース操作

**CRUD操作** = Create（作成）、Read（読取）、Update（更新）、Delete（削除）

**テスト項目**:
- ✅ データを作成できる
- ✅ データを読み取れる
- ✅ データを更新できる
- ✅ データを削除できる
- ✅ ユーザーを削除したら、そのユーザーのアイテムも自動削除される（カスケード削除）

**💡 外部キー制約**: あるデータが別のデータを参照している関係。
例: アイテムは必ずユーザーに紐づいている

### ✅ APIエンドポイント

**テスト項目**:
- ✅ 正しいステータスコードが返る（200 OK、404 Not Foundなど）
- ✅ レスポンスの形式が正しい（JSON形式、必須項目が含まれているなど）
- ✅ ページネーション（ページ分割）が動く
- ✅ エラー時に適切なメッセージが返る

**💡 ステータスコード**: HTTPの応答結果を表す数字
- **200**: 成功
- **400**: リクエストが間違っている
- **401**: 認証が必要
- **404**: 見つからない
- **500**: サーバーエラー

### ✅ フロントエンド（画面）

**テスト項目**:
- ✅ フォームに入力できる
- ✅ ボタンを押したら処理が実行される
- ✅ データが画面に表示される
- ✅ エラーメッセージが表示される

---

## 🔧 使用するテストツール（フレームワーク）

### Node.js プロジェクト用

| ツール名 | 役割 | 説明 |
|---------|------|------|
| **Jest** | バックエンドテストの実行 | JavaScriptのテストを実行する人気ツール |
| **Supertest** | APIのテスト | HTTPリクエストを送ってレスポンスを確認 |
| **Vitest** | フロントエンドテストの実行 | Vite（ビルドツール）に最適化されたテストツール |
| **React Testing Library** | Reactコンポーネントのテスト | ユーザー視点でコンポーネントをテスト |
| **Playwright** | E2Eテストの実行 | 実際のブラウザを操作してテスト |

### Python プロジェクト用

| ツール名 | 役割 | 説明 |
|---------|------|------|
| **pytest** | Pythonテストの実行 | Pythonで最も使われているテストツール |
| **pytest-asyncio** | 非同期処理のテスト | async/awaitを使ったコードのテスト（FastAPI用） |
| **pytest-flask** | Flaskアプリのテスト | Flask専用のテスト拡張 |
| **httpx** | HTTPリクエストのテスト | FastAPIのTestClientで使用 |
| **faker** | テストデータの生成 | ランダムなユーザー名やメールアドレスを自動生成 |

---

## 📖 プロジェクト別テスト詳細

### 1. nodejs-postgres テスト計画（56ケース）

#### 使用技術スタック
- **バックエンド**: Express（Node.jsのWebフレームワーク）+ TypeScript（型付きJavaScript）
- **フロントエンド**: React 19 + Vite 6
- **データベース**: PostgreSQL（リレーショナルデータベース）+ Redis（高速キャッシュ）
- **認証方式**: JWT（トークンベース認証）+ bcrypt（パスワード暗号化）

#### テスト実行コマンド

```bash
# プロジェクトフォルダに移動
cd examples/nodejs-postgres

# 🧪 バックエンドテスト
npm test                    # 全テスト実行
npm run test:watch          # ファイル変更を監視して自動実行
npm run test:coverage       # カバレッジレポート生成

# 🎨 フロントエンドテスト
npm run test:client         # Reactコンポーネントのテスト

# 🌐 E2Eテスト（ブラウザ操作）
npm run test:e2e            # Playwrightで自動ブラウザテスト

# 🚀 全テスト実行
npm run test:all            # バックエンド + フロントエンド + E2E
```

#### 詳細テストケース

**認証テスト（15ケース）**:
```
✅ 有効なユーザー情報で登録成功
✅ 重複するusernameで登録失敗（409エラー）
✅ 重複するemailで登録失敗（409エラー）
✅ 無効なemailフォーマットで登録失敗
✅ パスワード8文字未満で登録失敗
✅ 必須項目欠落で登録失敗
✅ 正しい認証情報でログイン成功
✅ 間違ったパスワードでログイン失敗（401エラー）
✅ 存在しないユーザー名でログイン失敗
✅ 非アクティブユーザーでログイン失敗（403エラー）
✅ 有効なトークンで /auth/me にアクセス成功
✅ 無効なトークンでアクセス失敗
✅ トークンなしでアクセス失敗
✅ 期限切れトークンでアクセス失敗
✅ パスワードがbcryptで暗号化されている
```

**Users API テスト（10ケース）**:
```
✅ GET /api/users - ユーザー一覧取得
✅ ページネーション動作確認（page, limit パラメータ）
✅ GET /api/users/:id - 特定ユーザー取得
✅ 存在しないIDで404エラー
✅ トークンなしで401エラー
✅ レスポンスにパスワードハッシュが含まれていない
✅ ユーザーリストが作成日時で降順ソート
✅ limitパラメータが正しく適用
✅ offsetパラメータが正しく適用
✅ 合計件数が正確
```

**Items API テスト（14ケース）**:
```
✅ POST /api/items - 新規アイテム作成成功
✅ 必須フィールド欠落で400エラー
✅ トークンなしで401エラー
✅ GET /api/items - 全アイテム一覧取得
✅ ページネーション動作確認
✅ GET /api/items/:id - 特定アイテム取得
✅ 存在しないIDで404エラー
✅ 作成したアイテムのowner_idが認証ユーザーと一致
✅ priceが数値型で正しく保存
✅ アイテムリストが作成日時で降順ソート
✅ limitとoffsetが正しく動作
✅ 合計件数が正確
```

**ヘルスチェックテスト（5ケース）**:
```
✅ GET / - ルートエンドポイント動作確認
✅ GET /health - ヘルスチェック成功
✅ GET /db - PostgreSQL接続確認
✅ GET /redis - Redis接続確認
✅ 存在しないエンドポイントで404エラー
```

**データベーステスト（8ケース）**:
```
✅ usersテーブルの存在とスキーマ確認
✅ itemsテーブルの存在とスキーマ確認
✅ 外部キー制約の動作確認（items.owner_id → users.id）
✅ ユーザー削除時、関連アイテムがカスケード削除
✅ 存在しないowner_idでアイテム作成時エラー
✅ usernameのユニーク制約が機能
✅ emailのユニーク制約が機能
✅ データベース接続プールの正常動作
```

**フロントエンドテスト（10ケース）**:
```
✅ ログインフォームがレンダリングされる
✅ ログイン成功時、トークンがlocalStorageに保存
✅ ログイン失敗時、エラーメッセージ表示
✅ 登録フォームに切り替え可能
✅ ユーザーリストが正しくレンダリング
✅ データ取得中にローディング表示
✅ エラー時にエラーメッセージ表示
✅ アイテムリストが正しくレンダリング
✅ 新規アイテム作成フォームが機能
✅ 作成成功時にリストが更新
```

**E2Eテスト（5ケース）**:
```
✅ ユーザー登録 → ログイン → ダッシュボード表示
✅ ログイン → ユーザー一覧閲覧 → ログアウト
✅ ログイン → アイテム作成 → アイテム一覧で確認
✅ 未認証状態でログインページにリダイレクト
✅ トークン期限切れ時に自動ログアウト
```

---

### 2. python-fastapi テスト計画（58ケース）

#### 使用技術スタック
- **バックエンド**: FastAPI（Pythonの高速Webフレームワーク）+ SQLAlchemy 2.0（データベースORM）
- **フロントエンド**: React 19 + Vite 6
- **データベース**: PostgreSQL（非同期処理: asyncpg）+ Redis
- **認証方式**: JWT（python-jose）+ bcrypt（passlib）

#### テスト実行コマンド

```bash
# プロジェクトフォルダに移動
cd examples/python-fastapi

# 🧪 バックエンドテスト
pytest                      # 全テスト実行
pytest -v                   # 詳細表示モード
pytest --cov                # カバレッジレポート生成
pytest -k "test_auth"       # "test_auth"を含むテストのみ実行

# 🎨 フロントエンドテスト
npm run test:client

# 🌐 E2Eテスト
npm run test:e2e
```

#### 詳細テストケース

**認証テスト（16ケース）**:
```
✅ 有効なユーザー情報で登録成功（201 Created）
✅ レスポンスにaccess_tokenが含まれる
✅ 重複するusernameで登録失敗（400 Bad Request）
✅ 重複するemailで登録失敗
✅ 無効なemailフォーマットで登録失敗（422 Unprocessable Entity）
✅ パスワード8文字未満で登録失敗
✅ Pydanticバリデーションエラーの形式確認
✅ 正しい認証情報でログイン成功
✅ OAuth2PasswordRequestForm形式でトークン取得
✅ レスポンスに token_type: bearer が含まれる
✅ 間違ったパスワードでログイン失敗（401）
✅ 存在しないusernameでログイン失敗
✅ 非アクティブユーザーでログイン失敗（400）
✅ 有効なトークンで /users/me にアクセス成功
✅ 無効なトークンでアクセス失敗
✅ トークンなしでアクセス失敗
```

**💡 Pydantic**: FastAPIで使用するデータ検証ライブラリ。
送信されたデータが正しい形式か自動でチェックしてくれる。

**💡 OAuth2PasswordRequestForm**: ログイン時のデータ形式の標準規格。
`application/x-www-form-urlencoded` 形式でユーザー名とパスワードを送信。

**Items API テスト（14ケース）**:
```
✅ POST /items - 新規アイテム作成成功（認証必須）
✅ Pydanticスキーマで正しく検証
✅ 必須フィールド欠落で422エラー
✅ トークンなしで401エラー
✅ GET /items - 全アイテム一覧取得
✅ skip/limitパラメータでページネーション
✅ GET /items/:id - 特定アイテム取得
✅ 存在しないIDで404エラー
✅ 作成したアイテムのowner_idが認証ユーザーと一致
✅ priceがfloat型で正しく保存
✅ descriptionがオプショナル（Noneも可）
✅ skipパラメータが正しく動作
✅ limitパラメータが正しく動作
✅ レスポンススキーマがPydanticモデルと一致
```

**ヘルスチェック・ドキュメントテスト（6ケース）**:
```
✅ GET / - ルートエンドポイント動作確認
✅ GET /health - ヘルスチェック成功
✅ GET /docs - Swagger UI（API仕様書）が利用可能
✅ GET /redoc - ReDoc（別形式のAPI仕様書）が利用可能
✅ GET /openapi.json - OpenAPIスキーマが取得可能
✅ 存在しないエンドポイントで404エラー
```

**💡 Swagger UI / ReDoc**: FastAPIが自動生成するAPI仕様書の画面。
ブラウザでAPIの使い方を確認したり、実際に試したりできる。

**データベース・CRUDテスト（12ケース）**:
```
✅ Userモデルが正しいカラムを持つ
✅ Itemモデルが正しいカラムを持つ
✅ 外部キー制約が定義されている
✅ create_user() - ユーザー作成とパスワードハッシュ化
✅ get_user_by_username() - usernameでユーザー取得
✅ get_user_by_email() - emailでユーザー取得
✅ authenticate_user() - 認証成功・失敗のテスト
✅ create_item() - アイテム作成とowner関連付け
✅ get_items() - skipとlimitでページネーション
✅ get_item() - ID指定でアイテム取得
✅ ユーザー削除時、関連アイテムがカスケード削除
✅ 非同期データベース操作が正しく動作
```

---

### 3. python-flask テスト計画（62ケース）

#### 使用技術スタック
- **バックエンド**: Flask（Pythonのシンプルなフレームワーク）+ Flask-SQLAlchemy
- **フロントエンド**: React 19 + Vite 6
- **データベース**: PostgreSQL（psycopg2）
- **認証方式**: JWT（PyJWT）+ Flask-Bcrypt

#### テスト実行コマンド

```bash
# プロジェクトフォルダに移動
cd examples/python-flask

# 🧪 バックエンドテスト
pytest                      # 全テスト実行
pytest -v                   # 詳細表示モード
pytest --cov                # カバレッジレポート生成
pytest -k "test_items"      # "test_items"を含むテストのみ実行

# 🎨 フロントエンドテスト
npm run test:client

# 🌐 E2Eテスト
npm run test:e2e
```

#### 詳細テストケース

**認証テスト（15ケース）**:
```
✅ 有効なユーザー情報で登録成功（201 Created）
✅ レスポンスにaccess_tokenが含まれる
✅ 重複するusernameで登録失敗（400）
✅ 重複するemailで登録失敗
✅ 無効なemailフォーマットで登録失敗
✅ パスワード8文字未満で登録失敗
✅ 正しい認証情報でログイン成功
✅ 間違ったパスワードでログイン失敗（401）
✅ 存在しないusernameでログイン失敗
✅ 非アクティブユーザーでログイン失敗（403）
✅ 有効なトークンで /auth/me にアクセス成功
✅ 無効なトークンでアクセス失敗
✅ トークンなしでアクセス失敗
✅ パスワードがFlask-Bcryptで暗号化
✅ トークンにユーザー情報が正しくエンコード
```

**Users API テスト（13ケース）**:
```
✅ GET /api/users - 全ユーザー一覧取得
✅ page/per_pageパラメータでページネーション
✅ GET /api/users/:id - 特定ユーザー取得
✅ 存在しないIDで404エラー
✅ POST /api/users - 新規ユーザー作成成功（認証必須）
✅ 必須フィールド欠落で400エラー
✅ トークンなしで401エラー
✅ GET /api/users/:id/items - ユーザーのアイテム一覧取得
✅ レスポンスにパスワードハッシュが含まれていない
✅ ユーザーリストが作成日時で降順ソート
✅ pageとper_pageパラメータが正しく動作
✅ 合計件数が正確
✅ paginationメタデータが正しい
```

**Items API テスト（16ケース）**:
```
✅ POST /api/items - 新規アイテム作成成功
✅ 必須フィールド欠落で400エラー
✅ トークンなしで401エラー
✅ GET /api/items - 全アイテム一覧取得
✅ ページネーション動作確認
✅ GET /api/items/:id - 特定アイテム取得
✅ 存在しないIDで404エラー
✅ PUT /api/items/:id - アイテム更新成功（認証必須）
✅ 他のユーザーのアイテムは更新不可（403 Forbidden）
✅ PUT時にトークンなしで401エラー
✅ DELETE /api/items/:id - アイテム削除成功
✅ 他のユーザーのアイテムは削除不可（403）
✅ DELETE時にトークンなしで401エラー
✅ 作成したアイテムのowner_idが認証ユーザーと一致
✅ priceがfloat型で正しく保存
✅ アイテムリストが作成日時で降順ソート
```

**💡 Flask独自の機能**: Flaskでは`PUT`（更新）と`DELETE`（削除）のエンドポイントも実装されています。
Node.jsやFastAPIの例では実装されていない機能です。

**ヘルスチェックテスト（5ケース）**:
```
✅ GET / - ルートエンドポイント動作確認
✅ GET /health - ヘルスチェック成功
✅ GET /api/db-test - PostgreSQL接続確認
✅ 存在しないエンドポイントで404エラー
✅ CORSヘッダーが正しく設定されている
```

**データベーステスト（9ケース）**:
```
✅ Userモデルが正しいカラムを持つ
✅ Itemモデルが正しいカラムを持つ
✅ 外部キー制約が機能
✅ ユーザー削除時、関連アイテムがカスケード削除
✅ 存在しないowner_idでアイテム作成時エラー
✅ usernameのユニーク制約が機能
✅ emailのユニーク制約が機能
✅ User.itemsリレーションシップが正しく動作
✅ Item.ownerリレーションシップが正しく動作
```

---

## 📊 カバレッジ目標

**カバレッジ**とは、テストによって実際に実行されたコードの割合です。

### 目標値

| プロジェクト | バックエンド全体 | 認証モジュール | APIエンドポイント | フロントエンド |
|------------|----------------|-------------|----------------|--------------|
| **nodejs-postgres** | 75%以上 | 90%以上 | 100% | 70%以上 |
| **python-fastapi** | 80%以上 | 90%以上 | 100% | 70%以上 |
| **python-flask** | 80%以上 | 90%以上 | 100% | 70%以上 |

### カバレッジレポートの見方

```bash
# カバレッジレポート生成
npm run test:coverage  # Node.js
pytest --cov          # Python

# HTMLレポートをブラウザで開く
open coverage/index.html      # Node.js
open htmlcov/index.html       # Python
```

レポートには以下が表示されます：
- **緑色の行**: テストで実行された（カバーされた）
- **赤色の行**: テストで実行されなかった
- **黄色の行**: 一部のみ実行された（条件分岐など）

---

## 🚀 テストの実行方法（初心者向け手順）

### ステップ1: 環境準備

```bash
# 1. リポジトリのクローン（ダウンロード）
git clone <リポジトリURL>
cd 2025-11-21_VSCode_Docker_Devloper

# 2. VSCodeでプロジェクトを開く
# 例: nodejs-postgres をテストする場合
cd examples/nodejs-postgres
code .
```

### ステップ2: Dev Containerで開く

1. VSCodeで `F1` キーを押す
2. 「Dev Containers: Reopen in Container」を選択
3. コンテナのビルドを待つ（初回は5-10分）

### ステップ3: データベース初期化

```bash
# Node.js プロジェクト
npm run db:setup

# Python プロジェクト
python init_db.py
```

### ステップ4: サーバー起動

```bash
# Node.js（2つのターミナルで実行）
# ターミナル1
npm run server:dev    # バックエンド起動

# ターミナル2
npm run client:dev    # フロントエンド起動

# Python Flask
python app.py

# Python FastAPI
fastapi dev main.py --host 0.0.0.0 --port 8000
```

### ステップ5: テスト実行

```bash
# バックエンドテスト
npm test      # Node.js
pytest        # Python

# フロントエンドテスト
npm run test:client

# E2Eテスト（サーバー起動後）
npm run test:e2e
```

---

## 🐛 トラブルシューティング（よくある問題と解決方法）

### 問題1: データベースに接続できない

**エラーメッセージ例**:
```
ECONNREFUSED ::1:5433
```

**解決方法**:
```bash
# 1. PostgreSQLコンテナが起動しているか確認
docker compose ps

# 2. 起動していない場合
docker compose up -d db

# 3. データベースを初期化
npm run db:setup     # Node.js
python init_db.py    # Python
```

### 問題2: テストがタイムアウトする

**エラーメッセージ例**:
```
Timeout of 5000ms exceeded
```

**解決方法**:
- データベースの起動を待つ時間が足りない可能性があります
- `tests/setup.ts` や `conftest.py` でタイムアウト時間を延長してください

```typescript
// Node.js の場合
jest.setTimeout(30000);  // 30秒に延長
```

```python
# Python の場合
@pytest.fixture(scope="session")
def client():
    # タイムアウトを延長する設定を追加
```

### 問題3: ポートが既に使用されている

**エラーメッセージ例**:
```
EADDRINUSE: address already in use :::3000
```

**解決方法**:
```bash
# 使用しているプロセスを確認
lsof -i :3000

# プロセスを終了
kill -9 <プロセスID>
```

---

## 📚 参考資料

### 公式ドキュメント

**テストフレームワーク**:
- [Jest（日本語）](https://jestjs.io/ja/)
- [Vitest](https://vitest.dev/)
- [Playwright](https://playwright.dev/)
- [pytest（日本語）](https://docs.pytest.org/en/stable/)

**Webフレームワーク**:
- [Express（日本語）](https://expressjs.com/ja/)
- [FastAPI（日本語）](https://fastapi.tiangolo.com/ja/)
- [Flask（日本語）](https://flask.palletsprojects.com/ja/)

### 学習リソース

- [JavaScript テスト入門](https://jsprimer.net/basic/testing/)
- [Python テスト入門](https://docs.python.org/ja/3/library/unittest.html)

---

## ✅ 次にやること

1. **依存関係のインストール**
   ```bash
   npm install      # Node.js
   pip install -r requirements-dev.txt  # Python
   ```

2. **テストを1つずつ実行して理解する**
   ```bash
   # 1つのテストファイルだけ実行
   npm test tests/auth.test.ts    # Node.js
   pytest tests/test_auth.py      # Python
   ```

3. **テストコードを読んで学ぶ**
   - どのようにAPIをテストしているか
   - どのようにデータベースをテストしているか
   - どのようにエラーケースをテストしているか

4. **新しいテストを書いてみる**
   - 既存のテストをコピーして修正
   - 新しい機能を追加したら、そのテストも追加

---

## 📞 サポート

- **詳細な手順**: 各プロジェクトの `TESTING.md` を参照
- **問題が解決しない場合**: GitHubのIssueで質問してください

---

**作成日**: 2025-11-22
**最終更新**: 2025-11-22
**バージョン**: 2.0.0（初心者向け）
