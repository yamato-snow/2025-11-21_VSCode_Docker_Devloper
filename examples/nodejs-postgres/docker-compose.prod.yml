# ==========================================
# 本番環境用 Docker Compose（オーバーライド）
# 使用方法:
# docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ==========================================
version: '3.8'

services:
  app:
    ports:
      - "80:3000"

    environment:
      - LOG_LEVEL=error  # 本番環境ではエラーログのみ
      - NODE_OPTIONS=--max-old-space-size=2048

    # リソース制限
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

      # スケーリング（Docker Swarmの場合）
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  db:
    # 本番用PostgreSQL設定
    environment:
      - POSTGRES_SHARED_BUFFERS=256MB
      - POSTGRES_MAX_CONNECTIONS=100
      - POSTGRES_WORK_MEM=4MB

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  redis:
    # 本番用Redis設定
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==========================================
  # Nginxリバースプロキシ（本番環境のみ）
  # ==========================================
  nginx:
    image: nginx:alpine
    restart: always

    ports:
      - "443:443"
      - "80:80"

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx

    depends_on:
      - app

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

volumes:
  nginx_cache:
